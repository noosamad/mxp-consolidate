PROCEDURE reportScript
.///////////////////////////////////////////////////////////////////////////////
.// Procedure: BackupMapping
.// Author: Greg Parsons
.// This procedure creates a backup CSV of the current mapping table so it can 
.// be restored later if required. 
.// 
.///////////////////////////////////////////////////////////////////////////////
API_START
DEFAULT backupfilename='mapbackup.csv'
_STORAGE='entity.ini'
READ STORAGE
PROJECT #_apiLibrary
MODEL 'MappingTable'
OPEN DOS #backupfilename READ
WHEN _READEXIST
	DELETE DOS #backupfilename
ENDWHEN
OPEN DOS #backupfilename WRITE
nr=getLeaves('Entity','entity')
... load all the data from the trasnaction model into list variables
reccnt=0
FOR entcnt,1,nr,1
	curentity=entity[entcnt]
	LOCATE 'Entity' SELECT #curentity
	READ MEMORY 'All'
	EXTcode=SERIES1
	EXTFullAccount=SERIES2
	EXTAccount=SERIES3
	CCOAcode=SERIES4
	nritems=ITEMSINFO('EXTCode','ITEMS')
	FOR icnt,1,nritems,1
		line=concat(entity[icnt],',',EXTcode[icnt],',',EXTFullAccount[icnt],',',EXTAccount[icnt],',',CCOAcode[icnt])
		WRITE DOS line
		reccnt=reccnt+1
	ENDFOR
ENDFOR
CLOSE DOS
msg=concat(reccnt,' records written to Mapping Table backup file','</BR>')
COPYHTML #msg
API_END
RETURN

	
	
